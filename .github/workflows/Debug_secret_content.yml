name: Debug Secret Content

on: [workflow_dispatch]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Debug Secret Structure
        run: |
          echo "=== Secret Analysis ==="
          echo "Secret exists: $([ -n "$GCP_SA_KEY" ] && echo "YES" || echo "NO")"
          echo "Secret length: ${#GCP_SA_KEY} characters"
          
          # Salvar e analisar o secret
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/secret.json
          echo "=== File info ==="
          ls -la /tmp/secret.json
          echo "=== First 500 chars ==="
          head -c 500 /tmp/secret.json
          echo ""
          echo "=== Last 100 chars ==="
          tail -c 100 /tmp/secret.json
          echo ""
          
          # Tentar parsear como JSON
          echo "=== JSON Validation ==="
          if python3 -c "import json; json.load(open('/tmp/secret.json'))"; then
            echo "✅ JSON is valid"
            echo "=== Client Email ==="
            python3 -c "import json; print(json.load(open('/tmp/secret.json'))['client_email'])"
          else
            echo "❌ JSON is INVALID"
          fi

      - name: Test Manual Auth
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/service-account.json
          gcloud auth activate-service-account --key-file=/tmp/service-account.json
          echo "=== After auth ==="
          gcloud auth list
          echo "=== Testing access ==="
          gcloud artifacts repositories list --location=southamerica-east1 --limit=1